<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa con Piscina en la Montaña - CloudHouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <header class="main-header">
        <div class="container">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <i class="fa-solid fa-house-chimney logo-house"></i>
                </div>
                <span class="logo-text">CloudHouse</span>
            </a>
            <nav class="main-nav" id="mainNav">
                <!-- Navigation will be dynamically updated based on authentication status -->
            </nav>
        </div>
    </header>

    <main class="container details-page-container">
        <section class="title-section">
            <h1>Villa con Piscina en la Montaña</h1>
            <div class="title-meta">
                <span class="rating"><i class="fa-solid fa-star"></i> 4.92 (120 reseñas)</span>
                <span class="location">La Calera, Cundinamarca, Colombia</span>
            </div>
        </section>

        <section class="image-gallery">
            <div class="main-image">
                <img src="https://images.unsplash.com/photo-1571896349842-33c89424de2d?q=80&w=1200&auto=format&fit=crop" alt="Vista principal del alojamiento">
            </div>
            <div class="thumbnail-images">
                <img src="https://images.unsplash.com/photo-1571896349842-33c89424de2d?q=80&w=600&auto=format&fit=crop" alt="Piscina de la villa">
                <img src="https://images.unsplash.com/photo-1564013799919-ab600027ffc6?q=80&w=600&auto=format&fit=crop" alt="Interior moderno">
                <img src="https://images.unsplash.com/photo-1416331108676-a22ccb276e35?q=80&w=600&auto=format&fit=crop" alt="Vista panorámica">
                <img src="https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=600&auto=format&fit=crop" alt="Zona de descanso">
            </div>
        </section>

        <div class="details-layout">
            <section class="main-details">
                <div class="details-header">
                    <h2>Villa completa. Anfitrión: David Felipe Pedraza</h2>
                    <div class="host-info">
                        <img src="https://placehold.co/50x50/cccccc/333333?text=DP" alt="Foto del anfitrión" class="host-avatar">
                    </div>
                </div>
                <hr>
                <div class="amenities-section">
                    <h3>Servicios destacados</h3>
                    <ul class="amenities-list">
                        <li><i class="fa-solid fa-wifi"></i> Wi-Fi</li>
                        <li><i class="fa-solid fa-person-swimming"></i> Piscina privada</li>
                        <li><i class="fa-solid fa-kitchen-set"></i> Cocina equipada</li>
                        <li><i class="fa-solid fa-car"></i> Estacionamiento gratuito</li>
                        <li><i class="fa-solid fa-tv"></i> Televisión HD</li>
                    </ul>
                </div>
                <hr>
                <div class="description-section">
                    <h3>Acerca de este lugar</h3>
                    <p>Disfruta de la tranquilidad y el aire fresco en esta espectacular villa de montaña. Perfecta para una escapada en familia o con amigos, cuenta con una piscina privada climatizada, amplias zonas verdes y una vista inmejorable. La casa está totalmente equipada para que te sientas como en casa.</p>
                </div>
                <hr>
                <div class="reviews-section">
                    <h3><i class="fa-solid fa-star"></i> 4.92 (120 reseñas)</h3>
                    <div class="reviews-grid">
                        <div class="review-card">
                            <div class="review-author">
                                <img src="https://placehold.co/40x40/ffc107/333?text=DA" alt="Avatar de usuario">
                                <div>
                                    <strong>Daniela Arboleda Trejos</strong>
                                    <span>Agosto 2025</span>
                                </div>
                            </div>
                            <p>Un lugar increíble para pasar el tiempo con mi novio, la vista es espectacular y la casa es muy cómoda. El señor Pedraza fue muy atento. ¡Volveremos sin duda!</p>
                        </div>
                        <div class="review-card">
                            <div class="review-author">
                                <img src="https://placehold.co/40x40/3f51b5/fff?text=DP" alt="Avatar de usuario">
                                <div>
                                    <strong>David Alfonso Posso Cano</strong>
                                    <span>Julio 2025</span>
                                </div>
                            </div>
                            <p>Perfecto para desconectarse de la ciudad. La piscina es genial y todo estaba impecable. 100% recomendado.</p>
                        </div>
                    </div>
                </div>
            </section>

            <aside class="booking-widget">
                <div class="booking-price">
                    <strong>$450,000 COP</strong> / noche
                </div>
                <div class="booking-form">
                    <div class="date-fields">
                        <input type="text" placeholder="Check-in">
                        <input type="text" placeholder="Check-out">
                    </div>
                    <input type="text" placeholder="Número de huéspedes">
                    <button class="btn btn-primary btn-block">Reservar</button>
                </div>
                <div class="price-breakdown">
                    <p>No se te cobrará nada aún</p>
                    <ul>
                        <li><span>$450,000 x 3 noches</span> <span>$1,350,000</span></li>
                        <li><span>Tarifa de servicio</span> <span>$150,000</span></li>
                    </ul>
                    <hr>
                    <p class="total-price"><span>Total</span> <span>$1,500,000</span></p>
                </div>
            </aside>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                 <div class="footer-section"><h4>CloudHouse</h4><ul><li><a href="#">Sobre Nosotros</a></li><li><a href="#">Prensa</a></li><li><a href="#">Carreras</a></li><li><a href="#">Políticas</a></li></ul></div>
                <div class="footer-section"><h4>Descubre</h4><ul><li><a href="#">Confianza y Seguridad</a></li><li><a href="#">Créditos de Viaje</a></li><li><a href="#">Ideas para Viajes</a></li></ul></div>
                <div class="footer-section"><h4>Anfitriones</h4><ul><li><a href="#">¿Por qué ser anfitrión?</a></li><li><a href="#">Hospitalidad</a></li><li><a href="#">Centro de la Comunidad</a></li></ul></div>
                <div class="footer-section social-media"><h4>Síguenos</h4><a href="#"><i class="fa-brands fa-facebook"></i></a><a href="#"><i class="fa-brands fa-twitter"></i></a><a href="#"><i class="fa-brands fa-instagram"></i></a></div>
            </div>
            <div class="footer-bottom"><p>&copy; 2025 CloudHouse. Todos los derechos reservados.</p></div>
        </div>
    </footer>


    <script src="auth.js"></script>
    <script>
        // AUTENTICACIÓN Y NAVEGACIÓN DINÁMICA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando página de detalles...');

            // Verificar autenticación y actualizar UI
            updateNavigation();

            // Verificar si el token está expirado
            if (auth.isAuthenticated() && auth.isTokenExpired()) {
                console.log('Token expirado, cerrando sesión...');
                auth.logout();
            }

            // Cargar detalles del alojamiento
            loadAccommodationDetails();
        });

        function updateNavigation() {
            const mainNav = document.getElementById('mainNav');
            const token = auth.getToken();
            const user = auth.getUser();
            const isAuth = auth.isAuthenticated();

            if (isAuth) {
                // Usuario logueado - mostrar navegación personalizada
                const isHost = auth.isHost();
                const initials = getInitials(user.name);

                mainNav.innerHTML = `
                    <ul>
                        <li><a href="#" class="user-welcome">¡Hola, ${user.name}!</a></li>
                        <li>
                            <div class="user-avatar" onclick="toggleUserMenu()">
                                <span class="avatar-initials">${initials}</span>
                                <div class="user-dropdown" id="userDropdown">
                                    <a href="#" onclick="editProfile()">
                                        <i class="fa-solid fa-user"></i>
                                        Editar Perfil
                                    </a>
                                    <a href="#" onclick="auth.logout()">
                                        <i class="fa-solid fa-right-from-bracket"></i>
                                        Cerrar Sesión
                                    </a>
                                </div>
                            </div>
                        </li>
                    </ul>
                `;
            } else {
                // Usuario no logueado - mostrar navegación pública
                mainNav.innerHTML = `
                    <ul>
                        <li><a href="login.html" class="btn btn-secondary">Iniciar Sesión</a></li>
                        <li><a href="register.html" class="btn btn-primary">Regístrate</a></li>
                    </ul>
                `;
            }
        }

        // Función para extraer iniciales del nombre
        function getInitials(name) {
            return name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }

        // Función para toggle del menú de usuario
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Función para editar perfil
        function editProfile() {
            // Cerrar el menú dropdown
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }

            // Redirigir a la página de edición de perfil
            window.location.href = 'profile_edit.html';
        }

        // Cerrar menú al hacer clic fuera de él
        document.addEventListener('click', function(event) {
            const avatar = document.querySelector('.user-avatar');
            const dropdown = document.getElementById('userDropdown');

            if (avatar && dropdown && !avatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Función para obtener parámetros de URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Función para cargar detalles del alojamiento
        async function loadAccommodationDetails() {
            try {
                // Obtener ID del alojamiento desde URL
                const accommodationId = getUrlParameter('id');

                console.log('ID del alojamiento desde URL:', accommodationId);
                console.log('URL completa:', window.location.href);

                if (!accommodationId) {
                    showError('ID de alojamiento no encontrado en la URL. Asegúrate de acceder desde la página principal.');
                    return;
                }

                console.log('Cargando detalles del alojamiento:', accommodationId);

                // Mostrar loading state
                showLoadingState();

                // URL del backend
                const apiUrl = `http://localhost:8080/api/alojamientos/${accommodationId}`;
                console.log('Haciendo petición a:', apiUrl);

                // Hacer la petición a la API
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Respuesta del servidor:', response.status, response.statusText);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Alojamiento no encontrado. El ID puede ser incorrecto.');
                    } else if (response.status === 403) {
                        throw new Error('No tienes permisos para ver este alojamiento');
                    } else if (response.status === 0) {
                        throw new Error('No se puede conectar al servidor. ¿Está el backend ejecutándose en http://localhost:8080?');
                    } else {
                        const errorText = await response.text();
                        console.error('Error del backend:', errorText);
                        throw new Error(`Error del servidor (${response.status}): ${response.statusText}`);
                    }
                }

                const result = await response.json();
                console.log('Respuesta JSON:', result);

                const accommodation = result.data;

                if (!accommodation) {
                    throw new Error('El servidor no devolvió datos del alojamiento');
                }

                console.log('Datos del alojamiento cargados:', accommodation);

                // Actualizar la página con los datos reales
                updatePageWithAccommodationData(accommodation);

            } catch (error) {
                console.error('Error al cargar detalles del alojamiento:', error);
                console.error('Stack trace:', error.stack);

                let errorMessage = error.message || 'Error desconocido al cargar los detalles del alojamiento';

                // Mensajes más específicos para errores comunes
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Error de conexión. Verifica que el backend esté ejecutándose en http://localhost:8080';
                }

                showError(errorMessage);
            }
        }

        // Función para mostrar estado de carga
        function showLoadingState() {
            // Agregar overlay de carga sobre el contenido existente
            const mainContent = document.querySelector('.details-page-container');
            if (mainContent) {
                // Crear overlay de carga
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                loadingOverlay.innerHTML = `
                    <div style="width: 40px; height: 40px; border: 4px solid var(--light-green); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div>
                    <h3>Cargando detalles del alojamiento...</h3>
                    <p>Por favor espera un momento.</p>
                `;

                // Agregar overlay al contenedor
                mainContent.appendChild(loadingOverlay);

                // Ocultar contenido original
                const originalContent = mainContent.querySelectorAll(':not(.loading-overlay)');
                originalContent.forEach(el => el.style.display = 'none');
            }
        }

        // Función para mostrar errores
        function showError(message) {
            const mainContent = document.querySelector('.details-page-container');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 2rem; text-align: center; color: var(--danger-color);">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                        <h3>Error al cargar alojamiento</h3>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="window.location.href='index.html'" style="margin-top: 1rem;">
                            <i class="fa-solid fa-home"></i> Volver al inicio
                        </button>
                    </div>
                `;
            }
        }

        // Función para actualizar la página con datos reales del alojamiento
        async function updatePageWithAccommodationData(accommodation) {
            console.log('Actualizando página con datos del alojamiento:', accommodation);

            try {
                // Remover overlay de carga
                const loadingOverlay = document.querySelector('.loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.remove();
                }

                // Mostrar contenido original
                const mainContent = document.querySelector('.details-page-container');
                if (mainContent) {
                    const allElements = mainContent.querySelectorAll('*');
                    allElements.forEach(el => {
                        if (!el.classList.contains('loading-overlay')) {
                            el.style.display = '';
                        }
                    });
                }

                // Actualizar título de la página
                document.title = `${accommodation.titulo} - CloudHouse`;
                console.log('Título de página actualizado');

                // Actualizar sección de título
                const titleSection = document.querySelector('.title-section');
                console.log('Elemento titleSection encontrado:', !!titleSection);

                if (titleSection) {
                    titleSection.innerHTML = `
                        <h1>${accommodation.titulo}</h1>
                        <div class="title-meta">
                            <span class="rating">
                                <i class="fa-solid fa-star"></i>
                                ${accommodation.promedioCalificaciones?.toFixed(1) || '0.0'}
                                (${accommodation.numeroCalificaciones || 0} reseñas)
                            </span>
                            <span class="location">
                                ${accommodation.direccion ? `${accommodation.direccion.ciudad}, ${accommodation.direccion.departamento || ''}` : 'Ubicación no especificada'}
                            </span>
                        </div>
                    `;
                    console.log('Sección de título actualizada');
                } else {
                    console.error('No se encontró el elemento .title-section');
                }

                // Actualizar galería de imágenes
                const imageGallery = document.querySelector('.image-gallery');
                console.log('Elemento imageGallery encontrado:', !!imageGallery);

                if (imageGallery && accommodation.imagenes && accommodation.imagenes.length > 0) {
                    const mainImage = accommodation.imagenes[0];
                    const thumbnails = accommodation.imagenes.slice(1, 5); // Máximo 4 miniaturas

                    imageGallery.innerHTML = `
                        <div class="main-image">
                            <img src="${mainImage}" alt="Vista principal del alojamiento">
                        </div>
                        <div class="thumbnail-images">
                            ${thumbnails.map(img => `<img src="${img}" alt="Vista del alojamiento">`).join('')}
                        </div>
                    `;
                    console.log('Galería de imágenes actualizada');
                } else {
                    console.log('No hay imágenes o no se encontró el elemento imageGallery');
                }

                // Actualizar detalles principales
                const mainDetails = document.querySelector('.main-details');
                console.log('Elemento mainDetails encontrado:', !!mainDetails);

                if (mainDetails) {
                    // Obtener información del anfitrión (placeholder por ahora)
                    const hostName = accommodation.nombreAnfitrion || 'Anfitrión';
                    const hostInitials = getInitials(hostName);

                    mainDetails.innerHTML = `
                        <div class="details-header">
                            <h2>Villa completa. Anfitrión: ${hostName}</h2>
                            <div class="host-info">
                                <img src="https://placehold.co/50x50/cccccc/333333?text=${hostInitials}" alt="Foto del anfitrión" class="host-avatar">
                            </div>
                        </div>
                        <hr>
                        <div class="amenities-section">
                            <h3>Servicios destacados</h3>
                            <ul class="amenities-list">
                                ${accommodation.servicios && accommodation.servicios.length > 0
                                    ? accommodation.servicios.map(servicio => {
                                        const iconMap = {
                                            'WIFI': 'fa-wifi',
                                            'PISCINA': 'fa-person-swimming',
                                            'COCINA_EQUIPADA': 'fa-kitchen-set',
                                            'ESTACIONAMIENTO': 'fa-car',
                                            'AIRE_ACONDICIONADO': 'fa-wind',
                                            'DESAYUNO': 'fa-utensils'
                                        };
                                        const icon = iconMap[servicio.toUpperCase()] || 'fa-check';
                                        return `<li><i class="fa-solid ${icon}"></i> ${servicio}</li>`;
                                    }).join('')
                                    : '<li><i class="fa-solid fa-info-circle"></i> Información de servicios no disponible</li>'
                                }
                            </ul>
                        </div>
                        <hr>
                        <div class="description-section">
                            <h3>Acerca de este lugar</h3>
                            <p>${accommodation.descripcion || 'Descripción no disponible.'}</p>
                        </div>
                        <hr>
                        <div class="reviews-section">
                            <h3>
                                <i class="fa-solid fa-star"></i>
                                ${accommodation.promedioCalificaciones?.toFixed(1) || '0.0'}
                                (${accommodation.numeroCalificaciones || 0} reseñas)
                            </h3>
                            <div class="reviews-grid">
                                <div class="review-placeholder">
                                    <p>Las reseñas se cargarán próximamente...</p>
                                </div>
                            </div>
                        </div>
                    `;
                    console.log('Detalles principales actualizados');
                } else {
                    console.error('No se encontró el elemento .main-details');
                }

                // Verificar si el usuario ya tiene una reserva para este alojamiento
                await checkExistingReservation(accommodation);

                console.log('Página actualizada exitosamente con datos del alojamiento');

            } catch (error) {
                console.error('Error al actualizar la página:', error);
                showError('Error al mostrar los datos del alojamiento: ' + error.message);
            }
        }

        // Función para verificar si el usuario ya tiene una reserva para este alojamiento
        async function checkExistingReservation(accommodation) {
            try {
                const user = auth.getUser();
                if (!user || !user.id) {
                    // Usuario no autenticado, mostrar formulario normal
                    showBookingForm(accommodation);
                    return;
                }

                // Verificar si existe una reserva para este usuario y alojamiento
                const response = await fetch(`http://localhost:8080/api/reservas/usuario/${user.id}/alojamiento/${accommodation.id}`, {
                    method: 'GET',
                    headers: auth.getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.data) {
                        // Ya tiene una reserva, mostrar estado
                        showReservationStatus(result.data);
                    } else {
                        // No tiene reserva, mostrar formulario
                        showBookingForm(accommodation);
                    }
                } else if (response.status === 404) {
                    // No tiene reserva, mostrar formulario
                    showBookingForm(accommodation);
                } else {
                    console.error('Error al verificar reserva existente');
                    showBookingForm(accommodation);
                }

            } catch (error) {
                console.error('Error al verificar reserva existente:', error);
                showBookingForm(accommodation);
            }
        }

        // Función para mostrar el formulario de reserva normal
        function showBookingForm(accommodation) {
            const bookingWidget = document.querySelector('.booking-widget');
            if (!bookingWidget) return;

            const precioPorNoche = accommodation.precioPorNoche || 0;
            const maxHuespedes = accommodation.maxHuespedes || 1;

            bookingWidget.innerHTML = `
                <div class="booking-price">
                    <strong>$${precioPorNoche.toLocaleString('es-CO')} COP</strong> / noche
                </div>
                <div class="booking-form">
                    <div class="date-fields">
                        <input type="date" id="checkin" placeholder="Check-in">
                        <input type="date" id="checkout" placeholder="Check-out">
                    </div>
                    <select id="guests" class="guest-select">
                        <option value="">Huéspedes</option>
                        ${Array.from({length: maxHuespedes}, (_, i) => i + 1)
                            .map(num => `<option value="${num}">${num} huésped${num > 1 ? 'es' : ''}</option>`)
                            .join('')}
                    </select>
                    <button class="btn btn-primary btn-block" onclick="handleReservation(${accommodation.id})">
                        <i class="fa-solid fa-calendar-check"></i> Reservar
                    </button>
                </div>
                <div class="price-breakdown">
                    <p>No se te cobrará nada aún</p>
                    <div id="priceBreakdown">
                        <p>Selecciona fechas para ver el precio total</p>
                    </div>
                </div>
            `;
        }

        // Función para mostrar el estado de la reserva existente
        function showReservationStatus(reservation) {
            const bookingWidget = document.querySelector('.booking-widget');
            if (!bookingWidget) return;

            const statusClass = getStatusClass(reservation.estado);
            const statusText = getStatusText(reservation.estado);

            bookingWidget.innerHTML = `
                <div class="reservation-status-widget">
                    <div class="status-header">
                        <h4>Estado de tu Reserva</h4>
                    </div>
                    <div class="status-info">
                        <div class="status-badge ${statusClass}">
                            ${statusText}
                        </div>
                        <div class="reservation-dates">
                            <p><i class="fa-solid fa-calendar-days"></i> ${formatDate(reservation.fechaEntrada)} - ${formatDate(reservation.fechaSalida)}</p>
                            <p><i class="fa-solid fa-users"></i> Reserva #${reservation.id}</p>
                        </div>
                        <div class="reservation-price">
                            <strong>$${reservation.precio?.toLocaleString('es-CO')} COP</strong>
                        </div>
                    </div>
                    ${reservation.estado === 'PENDIENTE' || reservation.estado === 'CONFIRMADA' ?
                        `<button class="btn btn-danger btn-block" onclick="cancelReservation(${reservation.id})">
                            <i class="fa-solid fa-times"></i> Cancelar Reserva
                        </button>` : ''}
                </div>
            `;
        }

        // Función para manejar reservas
        async function handleReservation(accommodationId) {
            const checkin = document.getElementById('checkin').value;
            const checkout = document.getElementById('checkout').value;
            const guests = document.getElementById('guests').value;

            if (!checkin || !checkout || !guests) {
                alert('Por favor completa todos los campos para hacer la reserva');
                return;
            }

            // Verificar si el usuario está autenticado
            if (!auth.isAuthenticated()) {
                // Mostrar mensaje de que necesita cuenta
                alert('Para hacer una reserva, necesitas tener una cuenta en CloudHouse. Registrate o inicia sesión');
                return;
            }

            // Usuario autenticado, proceder con la reserva
            await createReservation(accommodationId, checkin, checkout, guests);
        }


        // Función para crear reserva
        async function createReservation(accommodationId, checkin, checkout, guests) {
            try {
                const reservationData = {
                    alojamientoId: accommodationId,
                    fechaEntrada: checkin,
                    fechaSalida: checkout,
                    numeroHuespedes: parseInt(guests)
                };

                console.log('Enviando datos de reserva:', JSON.stringify(reservationData, null, 2));

                const response = await fetch('http://localhost:8080/api/reservas', {
                    method: 'POST',
                    headers: auth.getAuthHeaders(),
                    body: JSON.stringify(reservationData)
                });

                console.log('Respuesta del servidor:', response.status);

                const result = await response.json();
                console.log('Respuesta JSON:', result);

                if (response.ok && !result.error) {
                    alert('¡Reserva creada exitosamente!');
                    // Redirigir a la página de reservas
                    window.location.href = 'booking.html';
                } else {
                    alert('Error al crear la reserva: ' + (result.data || result.message || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al crear reserva:', error);
                alert('Error de conexión. Por favor intenta nuevamente.');
            }
        }
    </script>

    <style>
        /* Estilos para el avatar y menú desplegable */
        .user-avatar {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .avatar-initials {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--white-color);
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(46, 139, 87, 0.3);
        }

        .avatar-initials:hover {
            background-color: var(--accent-color);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(46, 139, 87, 0.4);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: var(--white-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 1px solid transparent;
        }

        .user-dropdown a:first-child {
            border-radius: 12px 12px 0 0;
        }

        .user-dropdown a:last-child {
            border-radius: 0 0 12px 12px;
            border-bottom: none;
        }

        .user-dropdown a:hover {
            background-color: var(--light-green);
            color: var(--primary-color);
        }

        .user-dropdown a i {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }

        .user-welcome {
            color: var(--primary-color) !important;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            background-color: var(--light-green);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .user-welcome:hover {
            background-color: var(--primary-color);
            color: var(--white-color) !important;
        }

        /* Estilos para la galería de imágenes */
        .image-gallery {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .main-image {
            position: relative;
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-images {
            display: grid;
            grid-template-rows: repeat(2, 1fr);
            gap: 1rem;
        }

        .thumbnail-images img {
            width: 100%;
            height: 195px;
            object-fit: cover;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .thumbnail-images img:hover {
            transform: scale(1.05);
        }

        /* Estilos para el widget de reserva */
        .booking-widget {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: sticky;
            top: 2rem;
        }

        .booking-price {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .date-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .date-fields input,
        .guest-select {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .btn-block {
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
        }

        .price-breakdown {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .price-breakdown p {
            color: var(--text-color);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .total-price {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        /* Responsive */
        /* Estilos para el widget de estado de reserva */
        .reservation-status-widget {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        .status-header h4 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }

        .status-info {
            margin-bottom: 2rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .status-badge.pending { background: var(--warning-color); color: white; }
        .status-badge.confirmed { background: var(--success-color); color: white; }
        .status-badge.completed { background: var(--info-color); color: white; }
        .status-badge.cancelled { background: var(--danger-color); color: white; }

        .reservation-dates p {
            margin: 0.5rem 0;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .reservation-dates i {
            color: var(--primary-color);
            margin-right: 0.5rem;
        }

        .reservation-price {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .image-gallery {
                grid-template-columns: 1fr;
            }

            .thumbnail-images {
                display: none;
            }

            .details-layout {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .date-fields {
                grid-template-columns: 1fr;
            }

            .reservation-status-widget {
                padding: 1.5rem;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 9999;
        }

    </style>

</body>
</html>