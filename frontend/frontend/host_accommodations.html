<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Alojamientos - CloudHouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style.css">
    <script src="auth.js"></script>
</head>
<body>

    <header class="main-header">
        <div class="container">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <i class="fa-solid fa-house-chimney logo-house"></i>
                </div>
                <span class="logo-text">CloudHouse</span>
            </a>
            <nav class="main-nav" id="mainNav">
                <!-- Navigation will be dynamically updated based on authentication status -->
            </nav>
        </div>
    </header>

    <main class="container dashboard-container">
        <div class="dashboard-layout">
            <aside class="dashboard-nav">
                <div class="user-profile-summary">
                    <img src="https://placehold.co/80x80/cccccc/333333?text=DA" alt="Foto del usuario" id="currentProfileImage">
                    <h3>Daniela Arboleda</h3>
                    <p id="userRole">Usuario desde 2025</p>
                </div>
                <ul>
                    <li><a href="host_dashboard.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="booking.html"><i class="fa-solid fa-calendar-check"></i> Mis Reservas</a></li>
                    <li class="active"><a href="host_accommodations.html"><i class="fa-solid fa-house-user"></i> Mis Alojamientos</a></li>
                    <li><a href="#"><i class="fa-solid fa-heart"></i> Favoritos</a></li>
                    <li><a href="profile_edit.html"><i class="fa-solid fa-user-pen"></i> Editar Perfil</a></li>
                    <li><a href="#"><i class="fa-solid fa-comments"></i> Comentarios</a></li>
                    <li><a href="#" id="goHomeLink"><i class="fa-solid fa-home"></i> Ir al inicio</a></li>
                </ul>
            </aside>

            <section class="dashboard-content">
                <div class="content-header">
                    <h1>Mis Alojamientos</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshAccommodations()">
                            <i class="fa-solid fa-refresh"></i> Actualizar
                        </button>
                        <a href="host_form.html" class="btn btn-primary">
                            <i class="fa-solid fa-plus"></i> Añadir Alojamiento
                        </a>
                    </div>
                </div>
                
                <!-- Filtros y Búsqueda -->
                <div class="filters-section">
                    <div class="filter-group">
                        <input type="text" id="searchInput" placeholder="Buscar alojamientos..." class="form-control">
                        <select id="cityFilter" class="form-control">
                            <option value="">Todas las ciudades</option>
                            <option value="Aremnia">Aremnia</option>
                            <option value="Bogot">Bogotá</option>
                            <option value="Medellín">Medellín</option>
                            <option value="Cali">Cali</option>
                        </select>
                        <select id="statusFilter" class="form-control">
                            <option value="">Todos los estados</option>
                            <option value="published">Publicado</option>
                            <option value="paused">Pausado</option>
                            <option value="draft">Borrador</option>
                        </select>
                        <select id="sortBy" class="form-control">
                            <option value="name">Ordenar por nombre</option>
                            <option value="created">Más recientes</option>
                            <option value="reservations">Más reservas</option>
                            <option value="rating">Mejor calificados</option>
                        </select>
                    </div>
                </div>

                <!-- Contenedor de Alojamientos -->
                <div class="accommodations-container" id="accommodationsContainer">
                    <div class="loading-state" id="loadingState">
                        <div class="spinner"></div>
                        <p>Cargando tus alojamientos...</p>
                    </div>
                    
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fa-solid fa-home"></i>
                        <h3>No tienes alojamientos publicados</h3>
                        <p>Comienza a publicar tus alojamientos para empezar a recibir reservas.</p>
                    </div>
                    
                    <div class="accommodations-grid" id="accommodationsGrid" style="display: none;">
                        <!-- Los alojamientos se cargarán dinámicamente aquí -->
                    </div>
                </div>

            </section>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom"><p>&copy; 2025 CloudHouse. Todos los derechos reservados.</p></div>
        </div>
    </footer>

    <style>
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filters-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
        }

        .form-control {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .accommodations-container {
            min-height: 400px;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-green);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-color);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--light-green);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--dark-green);
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        .accommodations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .accommodation-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .accommodation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .accommodation-image {
            position: relative;
            height: 200px;
            overflow: hidden;
        }

        .accommodation-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .accommodation-status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-published {
            background: var(--success-color);
            color: white;
        }

        .status-paused {
            background: var(--warning-color);
            color: white;
        }

        .status-draft {
            background: var(--text-color);
            color: white;
        }

        .accommodation-details {
            padding: 1.5rem;
        }

        .accommodation-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-green);
        }

        .accommodation-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-color);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .accommodation-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem;
            background: var(--light-green);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-color);
        }

        .accommodation-actions {
            display: flex;
            gap: 0.5rem;
        }

        .accommodation-actions .btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.8rem;
            text-align: center;
        }

        .btn-icon {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-icon:hover {
            opacity: 0.8;
        }

        .btn-edit {
            background: var(--primary-color);
            color: white;
        }

        .btn-pause {
            background: var(--warning-color);
            color: white;
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        /* Avatar de Usuario */
        .user-avatar {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .avatar-initials {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--white-color);
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(46, 139, 87, 0.3);
        }

        .avatar-initials:hover {
            background-color: var(--accent-color);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(46, 139, 87, 0.4);
        }

        /* Menú Dropdown */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: var(--white-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 1px solid transparent;
        }

        .user-dropdown a:first-child {
            border-radius: 12px 12px 0 0;
        }

        .user-dropdown a:last-child {
            border-radius: 0 0 12px 12px;
            border-bottom: none;
        }

        .user-dropdown a:hover {
            background-color: var(--light-green);
            color: var(--primary-color);
        }

        .user-dropdown a i {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }

        /* Responsive para móviles */
        @media (max-width: 768px) {
            .user-dropdown {
                right: -50px;
                min-width: 180px;
            }

            .avatar-initials {
                width: 36px;
                height: 36px;
                font-size: 12px;
            }

            .filter-group {
                grid-template-columns: 1fr;
            }

            .accommodations-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>

    <script>
        // AUTENTICACIÓN Y NAVEGACIÓN DINÁMICA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando autenticación...');

            // Verificar autenticación y actualizar UI
            updateNavigation();

            // Verificar si el token está expirado
            if (auth.isAuthenticated() && auth.isTokenExpired()) {
                console.log('Token expirado, cerrando sesión...');
                auth.logout();
            }

            // Verificar autenticación para el resto de la funcionalidad
            if (!auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Verificar que el usuario sea anfitrión
            if (!auth.isHost()) {
                alert('Solo los anfitriones pueden acceder a esta sección.');
                window.location.href = 'index.html';
                return;
            }

            // Cargar datos del usuario y alojamientos
            loadUserData();
            loadAccommodations();

            // Configurar event listeners
            setupEventListeners();
        });

        function updateNavigation() {
            const mainNav = document.getElementById('mainNav');
            const token = auth.getToken();
            const user = auth.getUser();
            const isAuth = auth.isAuthenticated();

            if (isAuth) {
                // Usuario logueado - mostrar solo avatar con menú desplegable
                const initials = getInitials(user.name);

                mainNav.innerHTML = `
                    <ul>
                        <li>
                            <div class="user-avatar" onclick="toggleUserMenu()">
                                <span class="avatar-initials">${initials}</span>
                                <div class="user-dropdown" id="userDropdown">
                                    <a href="#" onclick="auth.logout()">
                                        <i class="fa-solid fa-right-from-bracket"></i>
                                        Cerrar Sesión
                                    </a>
                                </div>
                            </div>
                        </li>
                    </ul>
                `;
            } else {
                // Usuario no logueado - mostrar navegación pública
                mainNav.innerHTML = `
                    <ul>
                        <li><a href="login.html" class="btn btn-secondary">Iniciar Sesión</a></li>
                        <li><a href="register.html" class="btn btn-primary">Regístrate</a></li>
                    </ul>
                `;
            }
        }

        // Función para extraer iniciales del nombre
        function getInitials(name) {
            return name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }

        // Función para toggle del menú de usuario
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Función para editar perfil
        function editProfile() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }

            // Redirigir a la página de edición de perfil
            window.location.href = 'profile_edit.html';
        }

        // Cerrar menú al hacer clic fuera de él
        document.addEventListener('click', function(event) {
            const avatar = document.querySelector('.user-avatar');
            const dropdown = document.getElementById('userDropdown');

            if (avatar && dropdown && !avatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Función para cargar datos del usuario
        async function loadUserData() {
            try {
                const user = auth.getUser();
                if (!user || !user.id) {
                    throw new Error('No se encontró información del usuario');
                }
                
                const response = await fetch(`http://localhost:8080/api/usuarios/${user.id}`, {
                    method: 'GET',
                    headers: auth.getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener datos del usuario');
                }
                
                const result = await response.json();
                const userData = result.data;
                
                // Actualizar la interfaz con los datos reales
                updateUIWithUserData(userData);
                
            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                alert('Error al cargar tu perfil. Por favor inicia sesión nuevamente.');
                auth.logout();
            }
        }
        
        // Función para actualizar la UI con los datos del usuario
        function updateUIWithUserData(userData) {
            // Actualizar header y navegación
            updateHeader(userData);
        }
        
        // Función para actualizar el header
        function updateHeader(userData) {
            // Actualizar navegación principal
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.innerHTML = `
                    <img src="${userData.foto || `https://placehold.co/50x50/cccccc/333333?text=${getInitials(userData.nombre)}`}" alt="Foto del usuario">
                    <span>${userData.nombre}</span>
                `;
            }
            
            // Actualizar sidebar
            const profileImage = document.getElementById('currentProfileImage');
            const profileName = document.querySelector('.user-profile-summary h3');
            const userRole = document.getElementById('userRole');
            
            if (profileImage) {
                profileImage.src = userData.foto || `https://placehold.co/80x80/cccccc/333333?text=${getInitials(userData.nombre)}`;
            }
            
            if (profileName) {
                profileName.textContent = userData.nombre;
            }
            
            // Año dinámico basado en la fecha de creación
            if (userRole) {
                let creationYear = '2025';
                if (userData.creadoEn) {
                    try {
                        creationYear = new Date(userData.creadoEn).getFullYear();
                    } catch (error) {
                        creationYear = '2025';
                    }
                } else {
                    creationYear = new Date().getFullYear();
                }
                userRole.textContent = `Usuario desde ${creationYear}`;
            }
            
            // Configurar redirecciones del menú
            configureMenuLinks();
        }
        
        // Función para configurar las redirecciones del menú
        function configureMenuLinks() {
            const navList = document.querySelector('.dashboard-nav ul');
            
            // Dashboard -> host_dashboard.html
            const dashboardItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Dashboard')
            );
            if (dashboardItem) {
                dashboardItem.querySelector('a').href = 'host_dashboard.html';
            }
            
            // Mis Reservas -> booking.html
            const reservationsItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Mis Reservas')
            );
            if (reservationsItem) {
                reservationsItem.querySelector('a').href = 'booking.html';
            }
            
            // Mis Alojamientos -> host_accommodations.html (ya está configurado)
            
            // Favoritos -> Mensaje informativo
            const favoritesItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Favoritos')
            );
            if (favoritesItem) {
                const favoritesLink = favoritesItem.querySelector('a');
                favoritesLink.href = '#';
                favoritesLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('Esta funcionalidad se implementará más adelante.');
                });
            }
            
            // Editar Perfil -> profile_edit.html
            const profileItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Editar Perfil')
            );
            if (profileItem) {
                profileItem.querySelector('a').href = 'profile_edit.html';
            }
            
            // Comentarios -> Mensaje informativo
            const commentsItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Comentarios')
            );
            if (commentsItem) {
                const commentsLink = commentsItem.querySelector('a');
                commentsLink.href = '#';
                commentsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('La funcionalidad se agregará más adelante');
                });
            }
            
            // Ir al inicio -> index.html
            const goHomeLink = document.getElementById('goHomeLink');
            if (goHomeLink) {
                goHomeLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = 'index.html';
                });
            }
        }
        
        // Función para obtener iniciales
        function getInitials(name) {
            return name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }
        
        // Función para cargar alojamientos
        async function loadAccommodations() {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const accommodationsGrid = document.getElementById('accommodationsGrid');
            
            try {
                // Mostrar loading
                loadingState.style.display = 'flex';
                emptyState.style.display = 'none';
                accommodationsGrid.style.display = 'none';
                
                // Obtener el ID del usuario autenticado
                const user = auth.getUser();
                if (!user || !user.id) {
                    throw new Error('No se encontró información del usuario autenticado');
                }
                
                // Usar el endpoint específico para alojamientos del usuario
                const response = await fetch(`http://localhost:8080/api/usuarios/${user.id}/alojamientos?pagina=0`, {
                    method: 'GET',
                    headers: auth.getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar alojamientos del usuario');
                }
                
                const result = await response.json();
                const accommodations = result.data || [];
                
                // Almacenar los alojamientos en la variable global para filtrado
                allAccommodations = accommodations;
                
                // Ocultar loading
                loadingState.style.display = 'none';
                
                if (accommodations.length === 0) {
                    emptyState.style.display = 'block';
                    accommodationsGrid.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    accommodationsGrid.style.display = 'grid';
                    renderAccommodations(accommodations);
                }
                
            } catch (error) {
                console.error('Error al cargar alojamientos:', error);
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <i class="fa-solid fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                    <h3>Error al cargar alojamientos</h3>
                    <p>No pudimos cargar tus alojamientos. Por favor intenta nuevamente.</p>
                    <button class="btn btn-primary" onclick="loadAccommodations()">
                        <i class="fa-solid fa-refresh"></i> Reintentar
                    </button>
                `;
            }
        }
        
        // Función para renderizar alojamientos
        function renderAccommodations(accommodations) {
            const accommodationsGrid = document.getElementById('accommodationsGrid');
            
            accommodationsGrid.innerHTML = accommodations.map(accommodation => `
                <div class="accommodation-card">
                    <div class="accommodation-image">
                        <img src="${accommodation.imagenPrincipal || 'https://placehold.co/400x200/cccccc/333333?text=Alojamiento'}" alt="${accommodation.titulo}">
                        <span class="accommodation-status status-published">
                            Publicado
                        </span>
                    </div>
                    <div class="accommodation-details">
                        <h3 class="accommodation-title">${accommodation.titulo}</h3>
                        <div class="accommodation-location">
                            <i class="fa-solid fa-map-marker-alt"></i>
                            <span>${accommodation.direccion ? `${accommodation.direccion.ciudad}, ${accommodation.direccion.departamento}` : 'Ubicación no especificada'}</span>
                        </div>
                        <div class="accommodation-stats">
                            <div class="stat-item">
                                <div class="stat-value">$${accommodation.precioPorNoche?.toFixed(0) || '0'}</div>
                                <div class="stat-label">Por noche</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">
                                    <i class="fa-solid fa-star"></i> ${accommodation.promedioCalificaciones?.toFixed(1) || '0.0'}
                                </div>
                                <div class="stat-label">Calificación</div>
                            </div>
                        </div>
                        <div class="accommodation-actions">
                            <button class="btn btn-edit" onclick="editAccommodation('${accommodation.id}')">
                                <i class="fa-solid fa-pen"></i> Editar
                            </button>
                            <button class="btn btn-pause" onclick="toggleAccommodationStatus('${accommodation.id}')">
                                <i class="fa-solid fa-pause"></i> Pausar
                            </button>
                            <button class="btn btn-delete" onclick="deleteAccommodation('${accommodation.id}')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Función para obtener texto de estado
        function getStatusText(estado) {
            switch(estado) {
                case 'PUBLICADO': return 'Publicado';
                case 'PAUSADO': return 'Pausado';
                case 'BORRADOR': return 'Borrador';
                default: return 'Desconocido';
            }
        }
        
        // Variables globales para almacenar los alojamientos
        let allAccommodations = [];
        
        // Función para configurar event listeners
        function setupEventListeners() {
            // Búsqueda
            document.getElementById('searchInput').addEventListener('input', filterAccommodations);
            
            // Filtros
            document.getElementById('cityFilter').addEventListener('change', filterAccommodations);
            document.getElementById('statusFilter').addEventListener('change', filterAccommodations);
            document.getElementById('sortBy').addEventListener('change', filterAccommodations);
        }
        
        // Función para filtrar alojamientos
        function filterAccommodations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cityFilter = document.getElementById('cityFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            // Filtrar los alojamientos
            let filteredAccommodations = allAccommodations.filter(accommodation => {
                // Filtrar por término de búsqueda (título)
                const matchesSearch = !searchTerm || 
                    accommodation.titulo.toLowerCase().includes(searchTerm);
                
                // Filtrar por ciudad
                const matchesCity = !cityFilter || 
                    (accommodation.direccion && accommodation.direccion.ciudad === cityFilter);
                
                // Filtrar por estado (todos los alojamientos están como "Publicado" por ahora)
                const matchesStatus = !statusFilter || statusFilter === 'published';
                
                return matchesSearch && matchesCity && matchesStatus;
            });
            
            // Ordenar los resultados
            filteredAccommodations = sortAccommodations(filteredAccommodations, sortBy);
            
            // Renderizar los resultados filtrados
            const accommodationsGrid = document.getElementById('accommodationsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredAccommodations.length === 0) {
                accommodationsGrid.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <i class="fa-solid fa-search"></i>
                    <h3>No se encontraron alojamientos</h3>
                    <p>No hay alojamientos que coincidan con los filtros seleccionados.</p>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="fa-solid fa-times"></i> Limpiar filtros
                    </button>
                `;
            } else {
                emptyState.style.display = 'none';
                accommodationsGrid.style.display = 'grid';
                renderAccommodations(filteredAccommodations);
            }
        }
        
        // Función para ordenar alojamientos
        function sortAccommodations(accommodations, sortBy) {
            const sorted = [...accommodations];
            
            switch(sortBy) {
                case 'name':
                    return sorted.sort((a, b) => a.titulo.localeCompare(b.titulo));
                case 'created':
                    return sorted.sort((a, b) => b.id - a.id); // Asumiendo que ID mayor = más reciente
                case 'reservations':
                    return sorted.sort((a, b) => (b.totalReservas || 0) - (a.totalReservas || 0));
                case 'rating':
                    return sorted.sort((a, b) => (b.promedioCalificaciones || 0) - (a.promedioCalificaciones || 0));
                default:
                    return sorted;
            }
        }
        
        // Función para limpiar filtros
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('cityFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('sortBy').value = 'name';
            
            // Recargar todos los alojamientos
            renderAccommodations(allAccommodations);
        }
        
        // Función para refrescar alojamientos
        function refreshAccommodations() {
            loadAccommodations();
        }
        
        // Función para editar alojamiento
        function editAccommodation(id) {
            window.location.href = `host_form.html?id=${id}`;
        }
        
        // Función para cambiar estado de alojamiento (no implementado en backend)
        function toggleAccommodationStatus(id) {
            alert('La funcionalidad de cambiar estado de alojamiento se implementará más adelante.');
        }
        
        // Función para eliminar alojamiento
        async function deleteAccommodation(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este alojamiento? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                const user = auth.getUser();
                if (!user || !user.id) {
                    throw new Error('No se encontró información del usuario autenticado');
                }
                
                const response = await fetch(`http://localhost:8080/api/alojamientos/${id}`, {
                    method: 'DELETE',
                    headers: auth.getAuthHeaders()
                });
                
                if (response.ok) {
                    alert('Alojamiento eliminado exitosamente');
                    // Recargar la lista de alojamientos
                    loadAccommodations();
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'Error al eliminar el alojamiento';
                    
                    if (response.status === 403) {
                        errorMessage = 'No tienes permisos para eliminar este alojamiento';
                    } else if (response.status === 404) {
                        errorMessage = 'El alojamiento no existe';
                    } else if (response.status === 409) {
                        errorMessage = 'No se puede eliminar un alojamiento con reservas activas';
                    }
                    
                    alert(errorMessage);
                }
                
            } catch (error) {
                console.error('Error al eliminar alojamiento:', error);
                alert('Error al eliminar el alojamiento. Por favor intenta nuevamente.');
            }
        }
    </script>

</body>
</html>
