<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Alojamiento - CloudHouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style.css">
    <script src="auth.js"></script>
</head>
<body>

    <header class="main-header">
        <div class="container">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <i class="fa-solid fa-house-chimney logo-house"></i>
                </div>
                <span class="logo-text">CloudHouse</span>
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="#" class="user-menu">
                        <img src="https://placehold.co/50x50/cccccc/333333?text=DA" alt="Foto del anfitrión">
                        <span>Daniela Arboleda</span>
                    </a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container dashboard-container">
        <div class="dashboard-layout">
            <aside class="dashboard-nav">
                <div class="user-profile-summary">
                    <img src="https://placehold.co/80x80/cccccc/333333?text=DA" alt="Foto del anfitrión" id="currentProfileImage">
                    <h3>Daniela Arboleda</h3>
                    <p id="userRole">Usuario desde 2025</p>
                </div>
                <ul>
                    <li><a href="host_dashboard.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a></li>
                    <li class="active"><a href="host_accommodations.html"><i class="fa-solid fa-house-user"></i> Mis Alojamientos</a></li>
                    <li><a href="booking.html"><i class="fa-solid fa-calendar-check"></i> Mis Reservas</a></li>
                    <li><a href="#"><i class="fa-solid fa-heart"></i> Favoritos</a></li>
                    <li><a href="profile_edit.html"><i class="fa-solid fa-user-pen"></i> Editar Perfil</a></li>
                    <li><a href="#"><i class="fa-solid fa-comments"></i> Comentarios</a></li>
                    <li><a href="#" id="goHomeLink"><i class="fa-solid fa-home"></i> Ir al inicio</a></li>
                </ul>
            </aside>

            <section class="dashboard-content">
                <div class="content-header">
                    <h1>Añadir Nuevo Alojamiento</h1>
                    <p>Completa la información para publicar tu alojamiento</p>
                </div>
                
                <div class="form-container">
                    <form id="accommodationForm">
                        <!-- Información Básica -->
                        <div class="form-section">
                            <h2><i class="fa-solid fa-info-circle"></i> Información Básica</h2>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="titulo">Título del Alojamiento *</label>
                                    <input type="text" id="titulo" name="titulo" required maxlength="150" 
                                           placeholder="Ej: Villa moderna con vistas al mar">
                                    <small>Máximo 150 caracteres</small>
                                </div>
                                <div class="form-group full-width">
                                    <label for="descripcion">Descripción *</label>
                                    <textarea id="descripcion" name="descripcion" required rows="6" 
                                              placeholder="Describe tu alojamiento, sus características y lo que lo hace especial..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="maxHuespedes">Capacidad Máxima *</label>
                                    <input type="number" id="maxHuespedes" name="maxHuespedes" required min="1" max="20" 
                                           placeholder="Número de huéspedes">
                                </div>
                                <div class="form-group">
                                    <label for="precioPorNoche">Precio por Noche (COP) *</label>
                                    <input type="number" id="precioPorNoche" name="precioPorNoche" required min="0" step="1000" 
                                           placeholder="Ej: 250000">
                                </div>
                            </div>
                        </div>

                        <!-- Ubicación -->
                        <div class="form-section">
                            <h2><i class="fa-solid fa-map-marker-alt"></i> Ubicación</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="ciudad">Ciudad *</label>
                                    <input type="text" id="ciudad" name="ciudad" required 
                                           placeholder="Ej: Bogotá D.C.">
                                </div>
                                <div class="form-group">
                                    <label for="direccion">Dirección *</label>
                                    <input type="text" id="direccion" name="direccion" required 
                                           placeholder="Ej: Carrera 10 #20-30">
                                </div>
                                <div class="form-group">
                                    <label for="latitud">Latitud *</label>
                                    <input type="number" id="latitud" name="latitud" required 
                                           step="any" min="-90" max="90" placeholder="Ej: 4.6097">
                                </div>
                                <div class="form-group">
                                    <label for="longitud">Longitud *</label>
                                    <input type="number" id="longitud" name="longitud" required 
                                           step="any" min="-180" max="180" placeholder="Ej: -74.0817">
                                </div>
                            </div>
                        </div>

                        <!-- Servicios -->
                        <div class="form-section">
                            <h2><i class="fa-solid fa-concierge-bell"></i> Servicios</h2>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label>Servicios Disponibles</label>
                                    <div class="checkbox-grid">
                                        <div class="checkbox-group">
                                            <div>
                                                <input type="checkbox" id="PISCINA" name="servicios" value="PISCINA">
                                                <label for="PISCINA">Piscina</label>
                                            </div>
                                        </div>
                                        <div class="checkbox-group">
                                            <div>
                                                <input type="checkbox" id="DESAYUNO" name="servicios" value="DESAYUNO">
                                                <label for="DESAYUNO">Desayuno</label>
                                            </div>
                                        </div>
                                        <div class="checkbox-group">
                                            <div>
                                                <input type="checkbox" id="AIRE_ACONDICIONADO" name="servicios" value="AIRE_ACONDICIONADO">
                                                <label for="AIRE_ACONDICIONADO">Aire Acondicionado</label>
                                            </div>
                                        </div>
                                        <div class="checkbox-group">
                                            <div>
                                                <input type="checkbox" id="WIFI" name="servicios" value="WIFI">
                                                <label for="WIFI">Wi-Fi</label>
                                            </div>
                                        </div>
                                        <div class="checkbox-group">
                                            <div>
                                                <input type="checkbox" id="ESTACIONAMIENTO" name="servicios" value="ESTACIONAMIENTO">
                                                <label for="ESTACIONAMIENTO">Estacionamiento</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Imágenes -->
                        <div class="form-section">
                            <h2><i class="fa-solid fa-images"></i> Imágenes</h2>
                            <div class="form-group">
                                <label>Imágenes del Alojamiento</label>
                                <p class="info-text">Por ahora se usarán imágenes placeholder. Más adelante podrás subir tus propias imágenes.</p>
                                <div class="image-preview-grid">
                                    <img src="https://placehold.co/400x300/cccccc/333333?text=Alojamiento+1" alt="Imagen 1">
                                    <img src="https://placehold.co/400x300/cccccc/333333?text=Alojamiento+2" alt="Imagen 2">
                                    <img src="https://placehold.co/400x300/cccccc/333333?text=Alojamiento+3" alt="Imagen 3">
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="form-navigation">
                            <button type="button" class="btn btn-secondary" onclick="cancelForm()">
                                <i class="fa-solid fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fa-solid fa-save"></i> Guardar Alojamiento
                            </button>
                        </div>
                    </form>
                </div>

            </section>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom"><p>&copy; 2025 CloudHouse. Todos los derechos reservados.</p></div>
        </div>
    </footer>

    <style>
        .form-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .form-section {
            margin-bottom: 3rem;
        }

        .form-section h2 {
            color: var(--dark-green);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-green);
        }

        .form-section h2 i {
            margin-right: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-green);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group small {
            color: var(--text-color);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .info-text {
            color: var(--text-color);
            font-style: italic;
            margin-bottom: 1rem;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .checkbox-group div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.3s ease;
        }

        .checkbox-group div:hover {
            border-color: var(--primary-color);
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview-grid img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .form-navigation {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 2rem;
            border-top: 2px solid var(--light-green);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-navigation {
                flex-direction: column;
            }
            
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            if (!auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Cargar datos del usuario
            loadUserData();
            
            // Configurar formulario
            setupForm();
        });
        
        // Función para cargar datos del usuario
        async function loadUserData() {
            try {
                const user = auth.getUser();
                if (!user || !user.id) {
                    throw new Error('No se encontró información del usuario');
                }
                
                const response = await fetch(`http://localhost:8080/api/usuarios/${user.id}`, {
                    method: 'GET',
                    headers: auth.getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener datos del usuario');
                }
                
                const result = await response.json();
                const userData = result.data;
                
                // Actualizar la interfaz con los datos reales
                updateUIWithUserData(userData);
                
            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                alert('Error al cargar tu perfil. Por favor inicia sesión nuevamente.');
                auth.logout();
            }
        }
        
        // Función para actualizar la UI con los datos del usuario
        function updateUIWithUserData(userData) {
            // Actualizar header y navegación
            updateHeader(userData);
        }
        
        // Función para actualizar el header
        function updateHeader(userData) {
            // Actualizar navegación principal
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.innerHTML = `
                    <img src="${userData.foto || `https://placehold.co/50x50/cccccc/333333?text=${getInitials(userData.nombre)}`}" alt="Foto del usuario">
                    <span>${userData.nombre}</span>
                `;
            }
            
            // Actualizar sidebar
            const profileImage = document.getElementById('currentProfileImage');
            const profileName = document.querySelector('.user-profile-summary h3');
            const userRole = document.getElementById('userRole');
            
            if (profileImage) {
                profileImage.src = userData.foto || `https://placehold.co/80x80/cccccc/333333?text=${getInitials(userData.nombre)}`;
            }
            
            if (profileName) {
                profileName.textContent = userData.nombre;
            }
            
            // Año dinámico basado en la fecha de creación
            if (userRole) {
                let creationYear = '2025';
                if (userData.creadoEn) {
                    try {
                        creationYear = new Date(userData.creadoEn).getFullYear();
                    } catch (error) {
                        creationYear = '2025';
                    }
                } else {
                    creationYear = new Date().getFullYear();
                }
                userRole.textContent = `Usuario desde ${creationYear}`;
            }
            
            // Configurar redirecciones del menú
            configureMenuLinks();
        }
        
        // Función para configurar las redirecciones del menú
        function configureMenuLinks() {
            const navList = document.querySelector('.dashboard-nav ul');
            
            // Dashboard -> host_dashboard.html
            const dashboardItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Dashboard')
            );
            if (dashboardItem) {
                dashboardItem.querySelector('a').href = 'host_dashboard.html';
            }
            
            // Mis Reservas -> booking.html
            const reservationsItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Mis Reservas')
            );
            if (reservationsItem) {
                reservationsItem.querySelector('a').href = 'booking.html';
            }
            
            // Mis Alojamientos -> host_accommodations.html (ya está configurado)
            
            // Favoritos -> Mensaje informativo
            const favoritesItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Favoritos')
            );
            if (favoritesItem) {
                const favoritesLink = favoritesItem.querySelector('a');
                favoritesLink.href = '#';
                favoritesLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('Esta funcionalidad se implementará más adelante.');
                });
            }
            
            // Editar Perfil -> profile_edit.html
            const profileItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Editar Perfil')
            );
            if (profileItem) {
                profileItem.querySelector('a').href = 'profile_edit.html';
            }
            
            // Comentarios -> Mensaje informativo
            const commentsItem = Array.from(navList.querySelectorAll('li')).find(li => 
                li.textContent.includes('Comentarios')
            );
            if (commentsItem) {
                const commentsLink = commentsItem.querySelector('a');
                commentsLink.href = '#';
                commentsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('La funcionalidad se agregará más adelante');
                });
            }
            
            // Ir al inicio -> index.html
            const goHomeLink = document.getElementById('goHomeLink');
            if (goHomeLink) {
                goHomeLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = 'index.html';
                });
            }
        }
        
        // Función para obtener iniciales
        function getInitials(name) {
            return name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }
        
        // Función para configurar el formulario
        function setupForm() {
            const form = document.getElementById('accommodationForm');
            const submitBtn = document.getElementById('submitBtn');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!validateForm()) {
                    return;
                }
                
                // Mostrar loading
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> Guardando...';
                
                try {
                    await saveAccommodation();
                    
                    // Éxito
                    alert('¡Alojamiento creado exitosamente!');
                    window.location.href = 'host_accommodations.html';
                    
                } catch (error) {
                    console.error('Error al guardar alojamiento:', error);
                    alert('Error al guardar el alojamiento: ' + error.message);
                } finally {
                    // Restaurar botón
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }
        
        // Función para validar el formulario
        function validateForm() {
            const titulo = document.getElementById('titulo').value.trim();
            const descripcion = document.getElementById('descripcion').value.trim();
            const maxHuespedes = document.getElementById('maxHuespedes').value;
            const precioPorNoche = document.getElementById('precioPorNoche').value;
            const ciudad = document.getElementById('ciudad').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const latitud = document.getElementById('latitud').value;
            const longitud = document.getElementById('longitud').value;
            
            // Validaciones básicas
            if (!titulo) {
                alert('El título es obligatorio');
                return false;
            }
            
            if (titulo.length > 150) {
                alert('El título no puede exceder 150 caracteres');
                return false;
            }
            
            if (!descripcion) {
                alert('La descripción es obligatoria');
                return false;
            }
            
            if (!maxHuespedes || maxHuespedes < 1 || maxHuespedes > 20) {
                alert('La capacidad debe estar entre 1 y 20 huéspedes');
                return false;
            }
            
            if (!precioPorNoche || precioPorNoche < 0) {
                alert('El precio por noche debe ser mayor o igual a 0');
                return false;
            }
            
            if (!ciudad) {
                alert('La ciudad es obligatoria');
                return false;
            }
            
            if (!direccion) {
                alert('La dirección es obligatoria');
                return false;
            }
            
            if (!latitud || latitud < -90 || latitud > 90) {
                alert('La latitud debe estar entre -90 y 90');
                return false;
            }
            
            if (!longitud || longitud < -180 || longitud > 180) {
                alert('La longitud debe estar entre -180 y 180');
                return false;
            }
            
            return true;
        }
        
        // Función para guardar el alojamiento
        async function saveAccommodation() {
            // Obtener servicios seleccionados
            const serviciosSeleccionados = [];
            const checkboxes = document.querySelectorAll('input[name="servicios"]:checked');
            checkboxes.forEach(checkbox => {
                serviciosSeleccionados.push(checkbox.value);
            });
            
            // Crear objeto con la estructura del backend
            const alojamientoData = {
                titulo: document.getElementById('titulo').value.trim(),
                descripcion: document.getElementById('descripcion').value.trim(),
                maxHuespedes: parseInt(document.getElementById('maxHuespedes').value),
                precioPorNoche: parseFloat(document.getElementById('precioPorNoche').value),
                direccion: {
                    ciudad: document.getElementById('ciudad').value.trim(),
                    direccion: document.getElementById('direccion').value.trim(),
                    localizacion: {
                        latitud: parseFloat(document.getElementById('latitud').value),
                        longitud: parseFloat(document.getElementById('longitud').value)
                    }
                },
                servicios: serviciosSeleccionados,
                imagenes: [
                    'https://placehold.co/400x300/cccccc/333333?text=Alojamiento+1',
                    'https://placehold.co/400x300/cccccc/333333?text=Alojamiento+2',
                    'https://placehold.co/400x300/cccccc/333333?text=Alojamiento+3'
                ]
            };
            
            // Crear FormData para enviar como multipart/form-data
            const formData = new FormData();
            
            // Agregar el objeto alojamiento como JSON
            formData.append('alojamiento', new Blob([JSON.stringify(alojamientoData)], { type: 'application/json' }));
            
            // No enviamos imágenes ya que usamos placeholders
            
            // Enviar al backend con multipart/form-data
            const response = await fetch('http://localhost:8080/api/alojamientos', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${auth.getToken()}`
                    // No establecer Content-Type, el navegador lo hace automáticamente para FormData
                },
                body: formData
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error ${response.status}: ${errorText}`);
            }
            
            return await response.json();
        }
        
        // Función para cancelar el formulario
        function cancelForm() {
            if (confirm('¿Estás seguro de que quieres cancelar? Los datos no guardados se perderán.')) {
                window.location.href = 'host_accommodations.html';
            }
        }
    </script>

</body>
</html>
