<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - ViviGo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <header class="main-header">
        <div class="container">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <i class="fa-solid fa-house-chimney logo-house"></i>
                </div>
                <span class="logo-text">ViviGo</span>
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="login.html">¿Ya tienes cuenta? Inicia Sesión</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container dashboard-container">
        <div class="register-layout" style="display: flex; justify-content: center; align-items: flex-start; min-height: calc(100vh - 200px); padding: 2rem 0;">
            <section class="dashboard-content" style="width: 100%; max-width: 800px; margin: 0;">
                <div class="content-header" style="text-align: center; margin-bottom: 3rem;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Únete a ViviGo</h1>
                    <p style="font-size: 1.2rem; color: #7F8C8D;">Crea tu cuenta y comienza tu aventura</p>
                </div>
                
                <div class="form-container">
                    <form id="registerForm">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 700px; margin: 0 auto;">
                            <div class="form-group">
                                <label for="firstName">Nombre *</label>
                                <input type="text" id="firstName" name="firstName" required placeholder="Tu nombre">
                                <div class="error-message" id="firstNameError"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="lastName">Apellido *</label>
                                <input type="text" id="lastName" name="lastName" required placeholder="Tu apellido">
                                <div class="error-message" id="lastNameError"></div>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="email">Correo Electrónico *</label>
                                <input type="email" id="email" name="email" required placeholder="tu@email.com">
                                <div class="error-message" id="emailError"></div>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="password">Contraseña *</label>
                                <input type="password" id="password" name="password" required placeholder="Mínimo 8 caracteres">
                                <div class="password-requirements">
                                    <p><i class="fa-solid fa-info-circle"></i> Debe contener al menos:</p>
                                    <ul>
                                        <li id="length">8 caracteres</li>
                                        <li id="uppercase">1 letra mayúscula</li>
                                        <li id="number">1 número</li>
                                    </ul>
                                </div>
                                <div class="error-message" id="passwordError"></div>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="confirmPassword">Confirmar Contraseña *</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Repite tu contraseña">
                                <div class="error-message" id="confirmPasswordError"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">Teléfono *</label>
                                <input type="tel" id="phone" name="phone" required placeholder="+57 300 123 4567">
                                <div class="error-message" id="phoneError"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="birthDate">Fecha de Nacimiento *</label>
                                <input type="date" id="birthDate" name="birthDate" required>
                                <div class="error-message" id="birthDateError"></div>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="role">Tipo de Usuario *</label>
                                <select id="role" name="role" required>
                                    <option value="guest">Huésped - Quiero reservar alojamientos</option>
                                </select>
                                <div class="error-message" id="roleError"></div>
                            </div>
                            
                            <div class="form-group full-width" style="display: block !important; flex-direction: initial !important;">
                                <div style="display: table; width: 100%;">
                                    <div style="display: table-cell; width: 20px; vertical-align: top; padding-top: 3px;">
                                        <input type="checkbox" id="terms" name="terms" required style="margin: 0; padding: 0;">
                                    </div>
                                    <div style="display: table-cell; vertical-align: top; padding-left: 8px;">
                                        <label for="terms" style="font-weight: 400; line-height: 1.5; cursor: pointer; margin: 0; display: block;">
                                            Acepto los <a href="#" style="color: var(--primary-color); font-weight: 600;">Términos y Condiciones</a> y la <a href="#" style="color: var(--primary-color); font-weight: 600;">Política de Privacidad</a> de ViviGo *
                                        </label>
                                    </div>
                                </div>
                                <div class="error-message" id="termsError"></div>
                            </div>
                            
                        </div>
                        
                        <div class="form-navigation" style="justify-content: center; border-top: none; padding-top: 2rem; max-width: 700px; margin: 0 auto;">
                            <button type="submit" id="registerButton" class="btn btn-primary" style="width: 300px; padding: 16px 24px; font-size: 1.1rem;">
                                <i class="fa-solid fa-user-plus"></i>
                                Crear mi cuenta
                            </button>
                        </div>
                    </form>
                    
                    <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-green); max-width: 700px; margin-left: auto; margin-right: auto;">
                        <p style="font-size: 1.1rem;">¿Ya tienes una cuenta? <a href="login.html" style="color: var(--primary-color); font-weight: 600;">Inicia Sesión</a></p>
                    </div>
                </div>

            </section>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom"><p>&copy; 2025 ViviGo. Todos los derechos reservados.</p></div>
        </div>
    </footer>

    <style>
        .password-requirements {
            background-color: var(--light-green);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .password-requirements p {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .password-requirements ul {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .password-requirements li {
            margin-bottom: 0.3rem;
            color: var(--text-color);
        }
        
        .password-requirements li.valid {
            color: var(--success-color);
        }
        
        .password-requirements li.valid::before {
            content: "✓ ";
            font-weight: bold;
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .form-group input.error,
        .form-group select.error {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registerForm');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            // Password strength validation
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                const lengthReq = document.getElementById('length');
                const uppercaseReq = document.getElementById('uppercase');
                const numberReq = document.getElementById('number');
                
                // Check length
                if (password.length >= 8) {
                    lengthReq.classList.add('valid');
                } else {
                    lengthReq.classList.remove('valid');
                }
                
                // Check uppercase
                if (/[A-Z]/.test(password)) {
                    uppercaseReq.classList.add('valid');
                } else {
                    uppercaseReq.classList.remove('valid');
                }
                
                // Check number
                if (/\d/.test(password)) {
                    numberReq.classList.add('valid');
                } else {
                    numberReq.classList.remove('valid');
                }
            });
            
            // Form validation
            form.addEventListener('submit', async function(e) {
                console.log('Formulario enviado'); // Debug
                e.preventDefault();
                
                let isValid = true;
                console.log('Iniciando validación'); // Debug
                
                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(error => {
                    error.classList.remove('show');
                });
                document.querySelectorAll('.error').forEach(input => {
                    input.classList.remove('error');
                });
                
                // Validate required fields
                const requiredFields = ['firstName', 'lastName', 'email', 'password', 'confirmPassword', 'phone', 'birthDate', 'role'];
                
                requiredFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    const errorElement = document.getElementById(fieldName + 'Error');
                    
                    if (!field.value.trim()) {
                        showError(field, errorElement, 'Este campo es obligatorio');
                        isValid = false;
                    }
                });
                
                // Validate email format
                let email = document.getElementById('email');
                let emailError = document.getElementById('emailError');
                let emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (email.value && !emailRegex.test(email.value)) {
                    showError(email, emailError, 'Por favor ingresa un email válido');
                    isValid = false;
                }
                
                // Validate password strength
                let password = passwordInput.value;
                let passwordError = document.getElementById('passwordError');
                
                if (password && (password.length < 8 || !/[A-Z]/.test(password) || !/\d/.test(password))) {
                    showError(passwordInput, passwordError, 'La contraseña no cumple con los requisitos');
                    isValid = false;
                }
                
                // Validate password confirmation
                let confirmPassword = confirmPasswordInput.value;
                let confirmPasswordError = document.getElementById('confirmPasswordError');
                
                if (password !== confirmPassword) {
                    showError(confirmPasswordInput, confirmPasswordError, 'Las contraseñas no coinciden');
                    isValid = false;
                }
                
                // Validate phone format
                let phone = document.getElementById('phone');
                let phoneError = document.getElementById('phoneError');
                let phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
                
                if (phone.value && !phoneRegex.test(phone.value)) {
                    showError(phone, phoneError, 'Por favor ingresa un teléfono válido');
                    isValid = false;
                }
                
                // Validate age (must be 18+)
                let birthDate = document.getElementById('birthDate');
                let birthDateError = document.getElementById('birthDateError');
                
                if (birthDate.value) {
                    let today = new Date();
                    let birth = new Date(birthDate.value);
                    let age = today.getFullYear() - birth.getFullYear();
                    let monthDiff = today.getMonth() - birth.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                        age--;
                    }
                    
                    if (age < 18) {
                        showError(birthDate, birthDateError, 'Debes ser mayor de 18 años para registrarte');
                        isValid = false;
                    }
                }
                
                // Validate terms acceptance
                let terms = document.getElementById('terms');
                let termsError = document.getElementById('termsError');
                
                if (!terms.checked) {
                    showError(terms, termsError, 'Debes aceptar los términos y condiciones');
                    isValid = false;
                }
                
                console.log('Validación finalizada, isValid:', isValid); // Debug
                if (isValid) {
                    console.log('Enviando formulario al backend'); // Debug
                    // Enviar datos al backend
                    await registerUser();
                } else {
                    console.log('Formulario no válido'); // Debug
                }
            });
            
            function showError(input, errorElement, message) {
                input.classList.add('error');
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }

            function mapRole(role) {
                // Mapear el rol al valor que espera el backend
                return 'USER';
            }

            async function registerUser() {
                console.log('Iniciando registerUser'); // Debug
                const submitButton = document.getElementById('registerButton');
                let originalText = submitButton.innerHTML;

                // Mostrar loading
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="loading-spinner"></span> Registrando...';

                try {
                    // Mapear datos del formulario según el DTO del backend
                    const formData = {
                        nombre: document.getElementById('firstName').value.trim() + ' ' + document.getElementById('lastName').value.trim(),
                        email: document.getElementById('email').value.trim(),
                        contrasena: document.getElementById('password').value,
                        telefono: document.getElementById('phone').value.trim(),
                        fechaNacimiento: document.getElementById('birthDate').value,
                        rol: mapRole(document.getElementById('role').value)
                    };

                    console.log('Datos a enviar:', formData); // Debug

                    // Enviar petición al backend
                    console.log('Enviando petición al backend...'); // Debug
                    const response = await fetch('http://localhost:8080/api/auth/registro', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    console.log('Respuesta recibida:', response.status); // Debug

                    let result;
                    try {
                        result = await response.json();
                    } catch (e) {
                        result = { mensaje: 'Error al procesar la respuesta del servidor' };
                    }

                    console.log('Respuesta del servidor:', result); // Debug

                    if (response.ok) {
                        // Registro exitoso
                        alert('¡Registro exitoso! Bienvenido a ViviGo. Ahora puedes iniciar sesión.');
                        window.location.href = 'login.html';
                    } else {
                        // Error del backend
                        if (result.mensaje) {
                            alert('Error: ' + result.mensaje);
                        } else {
                            alert('Error en el registro. Por favor intenta de nuevo.');
                        }
                    }

                } catch (error) {
                    console.error('Error:', error);
                    alert('Error de conexión. Por favor verifica que el servidor backend esté ejecutándose.');
                } finally {
                    // Restaurar botón
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            }
        });
    </script>

</body>
</html>
